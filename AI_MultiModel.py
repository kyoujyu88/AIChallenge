import tkinter as tk
from tkinter import scrolledtext, filedialog, messagebox, ttk # ttk„ÅØÊñ∞„Åó„ÅÑ„Éá„Ç∂„Ç§„É≥ÈÉ®ÂìÅ„Åß„Åô
import threading
from llama_cpp import Llama
import pandas as pd
import sys
import glob
import os

class AIChatApp:
    def __init__(self, root):
            self.root = root
                    self.root.title("Ê∏ö„ÅÆAIÂàÜÊûê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà („Éû„É´„ÉÅ„É¢„Éá„É´Áâà)")
                            self.root.geometry("800x800") 
                                    
                                            # --- 1. „Éá„Ç∂„Ç§„É≥ÈÉ®ÂàÜ ---
                                                    
                                                            # ‚òÖÊúÄ‰∏äÈÉ®Ôºö„É¢„Éá„É´ÈÅ∏Êäû„Ç®„É™„Ç¢ÔºàÊñ∞Ë®≠ÔºÅÔºâ
                                                                    model_frame = tk.Frame(root, bg="#e0e0e0", pady=5)
                                                                            model_frame.pack(side=tk.TOP, fill=tk.X)
                                                                                    
                                                                                            tk.Label(model_frame, text="‰ΩøÁî®„É¢„Éá„É´:", bg="#e0e0e0", font=("Meiryo", 10)).pack(side=tk.LEFT, padx=10)
                                                                                                    
                                                                                                            # „É¢„Éá„É´‰∏ÄË¶ß„ÇíÂèñÂæó„Åó„Å¶„Ç≥„É≥„Éú„Éú„ÉÉ„ÇØ„ÇπÔºà„Éó„É´„ÉÄ„Ç¶„É≥Ôºâ„Çí‰Ωú„Çä„Åæ„Åô
                                                                                                                    self.model_files = glob.glob("gguf/*.gguf") # gguf„Éï„Ç©„É´„ÉÄ„ÅÆ‰∏≠Ë∫´„ÇíÊ§úÁ¥¢
                                                                                                                            if not self.model_files:
                                                                                                                                        self.model_files = ["„É¢„Éá„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"]
                                                                                                                                                    
                                                                                                                                                            self.model_combo = ttk.Combobox(model_frame, values=self.model_files, width=50, state="readonly")
                                                                                                                                                                    # ÊúÄÂàù„Å´Ë¶ã„Å§„Åã„Å£„Åü„É¢„Éá„É´„Çí„Éá„Éï„Ç©„É´„Éà„ÅßÈÅ∏Êäû
                                                                                                                                                                            if self.model_files:
                                                                                                                                                                                        self.model_combo.current(0)
                                                                                                                                                                                                self.model_combo.pack(side=tk.LEFT, padx=5)
                                                                                                                                                                                                        
                                                                                                                                                                                                                # Âàá„ÇäÊõø„Åà„Éú„Çø„É≥
                                                                                                                                                                                                                        self.change_btn = tk.Button(model_frame, text="ÂàáÊõø„ÉªÂÜçË™≠Ëæº", command=self.reload_model_trigger,
                                                                                                                                                                                                                                                            bg="#98fb98", font=("Meiryo", 9))
                                                                                                                                                                                                                                                                    self.change_btn.pack(side=tk.LEFT, padx=5)


                                                                                                                                                                                                                                                                            # ‚òÖÊìç‰Ωú„Ç®„É™„Ç¢
                                                                                                                                                                                                                                                                                    top_frame = tk.Frame(root, bg="#f0f0f0", pady=10)
                                                                                                                                                                                                                                                                                            top_frame.pack(side=tk.TOP, fill=tk.X)
                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                            # CSV„Éú„Çø„É≥
                                                                                                                                                                                                                                                                                                                    self.csv_btn = tk.Button(top_frame, text="üìÇ CSVË™≠Ëæº", command=self.load_csv, 
                                                                                                                                                                                                                                                                                                                                                      bg="#87ceeb", fg="white", font=("Meiryo", 10, "bold"), width=12)
                                                                                                                                                                                                                                                                                                                                                              self.csv_btn.pack(side=tk.LEFT, padx=10)

                                                                                                                                                                                                                                                                                                                                                                      # ÂÖ•ÂäõÊ¨Ñ
                                                                                                                                                                                                                                                                                                                                                                              self.input_entry = tk.Entry(top_frame, font=("Meiryo", 12))
                                                                                                                                                                                                                                                                                                                                                                                      self.input_entry.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=5)
                                                                                                                                                                                                                                                                                                                                                                                              self.input_entry.bind("<Return>", self.send_message)
                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                              # ÈÄÅ‰ø°„Éú„Çø„É≥
                                                                                                                                                                                                                                                                                                                                                                                                                      self.send_btn = tk.Button(top_frame, text="ÈÄÅ‰ø°", command=self.send_message, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                        bg="#ffb6c1", fg="white", font=("Meiryo", 10, "bold"), width=10)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.send_btn.pack(side=tk.RIGHT, padx=10)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ‚òÖ„É≠„Ç∞„Ç®„É™„Ç¢
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.log_area = scrolledtext.ScrolledText(root, font=("Meiryo", 11), state='disabled')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.log_area.pack(expand=True, fill=tk.BOTH, padx=10, pady=10)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # --- 2. AI„ÅÆÊ∫ñÂÇô ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.system_prompt = "„Ç∑„Çπ„ÉÜ„É†: „ÅÇ„Å™„Åü„ÅØ„Éá„Éº„ÇøÂàÜÊûê„ÅåÂæóÊÑè„Å™AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇË´ñÁêÜÁöÑ„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.history = self.system_prompt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.llm = None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Ëµ∑ÂãïÊôÇ„Å´ÊúÄÂàù„ÅÆ„É¢„Éá„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.reload_model_trigger()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def reload_model_trigger(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # „Éú„Çø„É≥„ÅåÊäº„Åï„Çå„Åü„Çâ„É¢„Éá„É´Ë™≠„ÅøËæº„Åø„Çπ„É¨„ÉÉ„Éâ„ÇíÈñãÂßã
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            selected_model = self.model_combo.get()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if selected_model == "„É¢„Éá„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                messagebox.showerror("„Ç®„É©„Éº", "gguf„Éï„Ç©„É´„ÉÄ„Å´„É¢„Éá„É´„Éï„Ç°„Ç§„É´„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑÔºÅ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.append_log("„Ç∑„Çπ„ÉÜ„É†", f"„Äå{os.path.basename(selected_model)}„Äç„Å´Âàá„ÇäÊõø„Åà„Å¶„ÅÑ„Åæ„Åô...Ôºà„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑÔºâ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.root.title("Ê∏ö„ÅÆAIÂàÜÊûê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà („É¢„Éá„É´Ë™≠Ëæº‰∏≠...)")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.change_btn.config(state="disabled") # ÈÄ£ÊâìÈò≤Ê≠¢
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.send_btn.config(state="disabled")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        threading.Thread(target=self.load_model, args=(selected_model,), daemon=True).start()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def load_model(self, model_path):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Êó¢Â≠ò„ÅÆ„É¢„Éá„É´„Åå„ÅÇ„Çå„Å∞„É°„É¢„É™„ÇíËß£Êîæ...„Åß„Åç„Çå„Å∞„ÅÑ„ÅÑ„Åß„Åô„ÅåPython‰ªª„Åõ„Å´„Åó„Åæ„Åô
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.llm = None 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ‚òÖÁØ§Âøó„Åè„ÇìÂ∞ÇÁî®„ÉªÈôêÁïåÁ™ÅÁ†¥Ë®≠ÂÆöÔºà„Åï„Å£„Åç„ÅÆ„ÉÅ„É•„Éº„Éã„É≥„Ç∞Ôºâ‚òÖ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.llm = Llama(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                model_path=model_path,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                n_ctx=8192,      # Ë®òÊÜ∂ÂäõMAX
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                n_threads=4,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                n_batch=512,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                verbose=False
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ÂÆå‰∫ÜÂ†±Âëä
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.root.after(0, self.post_load_success, model_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.root.after(0, self.append_log, "„Ç®„É©„Éº", f"„É¢„Éá„É´Ë™≠ËæºÂ§±Êïó: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.root.after(0, lambda: self.change_btn.config(state="normal"))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def post_load_success(self, model_path):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„ÅÆÁîªÈù¢Êõ¥Êñ∞
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                model_name = os.path.basename(model_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.append_log("„Ç∑„Çπ„ÉÜ„É†", f"Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ‰ªä„ÅØ„Äå{model_name}„Äç„ÅåÊãÖÂΩì„Åó„Åæ„Åô„ÄÇ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.root.title(f"Ê∏ö„ÅÆAIÂàÜÊûê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà - {model_name}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.change_btn.config(state="normal")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.send_btn.config(state="normal")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def load_csv(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            file_path = filedialog.askopenfilename(filetypes=[("CSV„Éï„Ç°„Ç§„É´", "*.csv")])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if not file_path:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    df = pd.read_csv(file_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            info_text = f"„Äê„Éá„Éº„ÇøÊ¶ÇË¶Å„Äë\nË°åÊï∞: {df.shape[0]}, ÂàóÊï∞: {df.shape[1]}\n\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        info_text += f"„ÄêÂàóÂêç‰∏ÄË¶ß„Äë\n{', '.join(df.columns)}\n\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    info_text += f"„Äê„Éá„Éº„Çø„ÅÆÂÖàÈ†≠5Ë°å„Äë\n{df.head().to_string()}\n\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                info_text += f"„ÄêÁµ±Ë®àÊÉÖÂ†±„Äë\n{df.describe().to_string()}"

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        import tkinter as tk
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        from tkinter import scrolledtext, filedialog, messagebox, ttk  # ttk„ÅØÊñ∞„Åó„ÅÑ„Éá„Ç∂„Ç§„É≥ÈÉ®ÂìÅ„Åß„Åô
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        import threading
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        from llama_cpp import Llama
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        import pandas as pd
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        import sys
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        import glob
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        import os


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        class AIChatApp:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def __init__(self, root):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.root = root
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.root.title("Ê∏ö„ÅÆAIÂàÜÊûê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà („Éû„É´„ÉÅ„É¢„Éá„É´Áâà)")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.root.geometry("800x800")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # --- 1. „Éá„Ç∂„Ç§„É≥ÈÉ®ÂàÜ ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ‚òÖÊúÄ‰∏äÈÉ®Ôºö„É¢„Éá„É´ÈÅ∏Êäû„Ç®„É™„Ç¢ÔºàÊñ∞Ë®≠ÔºÅÔºâ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                model_frame = tk.Frame(root, bg="#e0e0e0", pady=5)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                model_frame.pack(side=tk.TOP, fill=tk.X)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tk.Label(model_frame, text="‰ΩøÁî®„É¢„Éá„É´:", bg="#e0e0e0", font=("Meiryo", 10)).pack(side=tk.LEFT, padx=10)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # „É¢„Éá„É´‰∏ÄË¶ß„ÇíÂèñÂæó„Åó„Å¶„Ç≥„É≥„Éú„Éú„ÉÉ„ÇØ„ÇπÔºà„Éó„É´„ÉÄ„Ç¶„É≥Ôºâ„Çí‰Ωú„Çä„Åæ„Åô
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.model_files = glob.glob("gguf/*.gguf")  # gguf„Éï„Ç©„É´„ÉÄ„ÅÆ‰∏≠Ë∫´„ÇíÊ§úÁ¥¢
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if not self.model_files:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.model_files = ["„É¢„Éá„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"]

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.model_combo = ttk.Combobox(model_frame, values=self.model_files, width=50, state="readonly")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if self.model_files:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.model_combo.current(0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.model_combo.pack(side=tk.LEFT, padx=5)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Âàá„ÇäÊõø„Åà„Éú„Çø„É≥
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.change_btn = tk.Button(model_frame, text="ÂàáÊõø„ÉªÂÜçË™≠Ëæº", command=self.reload_model_trigger,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            bg="#98fb98", font=("Meiryo", 9))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.change_btn.pack(side=tk.LEFT, padx=5)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ‚òÖÊìç‰Ωú„Ç®„É™„Ç¢
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                top_frame = tk.Frame(root, bg="#f0f0f0", pady=10)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                top_frame.pack(side=tk.TOP, fill=tk.X)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # CSV„Éú„Çø„É≥
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.csv_btn = tk.Button(top_frame, text="üìÇ CSVË™≠Ëæº", command=self.load_csv,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         bg="#87ceeb", fg="white", font=("Meiryo", 10, "bold"), width=12)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.csv_btn.pack(side=tk.LEFT, padx=10)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ÂÖ•ÂäõÊ¨Ñ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.input_entry = tk.Entry(top_frame, font=("Meiryo", 12))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.input_entry.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=5)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.input_entry.bind("<Return>", self.send_message)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ÈÄÅ‰ø°„Éú„Çø„É≥
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.send_btn = tk.Button(top_frame, text="ÈÄÅ‰ø°", command=self.send_message,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          bg="#ffb6c1", fg="white", font=("Meiryo", 10, "bold"), width=10)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.send_btn.pack(side=tk.RIGHT, padx=10)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ‚òÖ„É≠„Ç∞„Ç®„É™„Ç¢
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.log_area = scrolledtext.ScrolledText(root, font=("Meiryo", 11), state='disabled')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.log_area.pack(expand=True, fill=tk.BOTH, padx=10, pady=10)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # --- 2. AI„ÅÆÊ∫ñÂÇô ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.system_prompt = "„Ç∑„Çπ„ÉÜ„É†: „ÅÇ„Å™„Åü„ÅØ„Éá„Éº„ÇøÂàÜÊûê„ÅåÂæóÊÑè„Å™AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇË´ñÁêÜÁöÑ„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.history = self.system_prompt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.llm = None

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Ëµ∑ÂãïÊôÇ„Å´ÊúÄÂàù„ÅÆ„É¢„Éá„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.reload_model_trigger()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def reload_model_trigger(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                selected_model = self.model_combo.get()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if selected_model == "„É¢„Éá„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    messagebox.showerror("„Ç®„É©„Éº", "gguf„Éï„Ç©„É´„ÉÄ„Å´„É¢„Éá„É´„Éï„Ç°„Ç§„É´„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑÔºÅ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.append_log("„Ç∑„Çπ„ÉÜ„É†", f"„Äå{os.path.basename(selected_model)}„Äç„Å´Âàá„ÇäÊõø„Åà„Å¶„ÅÑ„Åæ„Åô...Ôºà„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑÔºâ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.root.title("Ê∏ö„ÅÆAIÂàÜÊûê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà („É¢„Éá„É´Ë™≠Ëæº‰∏≠...)")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.change_btn.config(state="disabled")  # ÈÄ£ÊâìÈò≤Ê≠¢
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.send_btn.config(state="disabled")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                threading.Thread(target=self.load_model, args=(selected_model,), daemon=True).start()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def load_model(self, model_path):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Êó¢Â≠ò„ÅÆ„É¢„Éá„É´„Åå„ÅÇ„Çå„Å∞„É°„É¢„É™„ÇíËß£Êîæ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.llm = None

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # „É¢„Éá„É´Ë™≠„ÅøËæº„Åø
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.llm = Llama(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        model_path=model_path,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        n_ctx=8192,      # Ë®òÊÜ∂ÂäõMAX
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        n_threads=4,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        n_batch=512,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        verbose=False
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ÂÆå‰∫ÜÂ†±Âëä
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.root.after(0, self.post_load_success, model_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.root.after(0, self.append_log, "„Ç®„É©„Éº", f"„É¢„Éá„É´Ë™≠ËæºÂ§±Êïó: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.root.after(0, lambda: self.change_btn.config(state="normal"))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def post_load_success(self, model_path):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                model_name = os.path.basename(model_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.append_log("„Ç∑„Çπ„ÉÜ„É†", f"Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ‰ªä„ÅØ„Äå{model_name}„Äç„ÅåÊãÖÂΩì„Åó„Åæ„Åô„ÄÇ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.root.title(f"Ê∏ö„ÅÆAIÂàÜÊûê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà - {model_name}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.change_btn.config(state="normal")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.send_btn.config(state="normal")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def load_csv(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                file_path = filedialog.askopenfilename(filetypes=[("CSV„Éï„Ç°„Ç§„É´", "*.csv")])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if not file_path:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    df = pd.read_csv(file_path)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    info_text = f"„Äê„Éá„Éº„ÇøÊ¶ÇË¶Å„Äë\nË°åÊï∞: {df.shape[0]}, ÂàóÊï∞: {df.shape[1]}\n\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    info_text += f"„ÄêÂàóÂêç‰∏ÄË¶ß„Äë\n{', '.join(df.columns)}\n\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    info_text += f"„Äê„Éá„Éº„Çø„ÅÆÂÖàÈ†≠5Ë°å„Äë\n{df.head().to_string()}\n\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    info_text += f"„ÄêÁµ±Ë®àÊÉÖÂ†±„Äë\n{df.describe().to_string()}"

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                import tkinter as tk
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                from tkinter import scrolledtext, filedialog, messagebox, ttk  # ttk„ÅØÊñ∞„Åó„ÅÑ„Éá„Ç∂„Ç§„É≥ÈÉ®ÂìÅ„Åß„Åô
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                import threading
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                from llama_cpp import Llama
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                import pandas as pd
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                import sys
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                import glob
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                import os


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                class AIChatApp:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def __init__(self, root):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.root = root
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.root.title("Ê∏ö„ÅÆAIÂàÜÊûê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà („Éû„É´„ÉÅ„É¢„Éá„É´Áâà)")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.root.geometry("800x800")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # --- 1. „Éá„Ç∂„Ç§„É≥ÈÉ®ÂàÜ ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ‚òÖÊúÄ‰∏äÈÉ®Ôºö„É¢„Éá„É´ÈÅ∏Êäû„Ç®„É™„Ç¢ÔºàÊñ∞Ë®≠ÔºÅÔºâ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        model_frame = tk.Frame(root, bg="#e0e0e0", pady=5)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        model_frame.pack(side=tk.TOP, fill=tk.X)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tk.Label(model_frame, text="‰ΩøÁî®„É¢„Éá„É´:", bg="#e0e0e0", font=("Meiryo", 10)).pack(side=tk.LEFT, padx=10)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # „É¢„Éá„É´‰∏ÄË¶ß„ÇíÂèñÂæó„Åó„Å¶„Ç≥„É≥„Éú„Éú„ÉÉ„ÇØ„ÇπÔºà„Éó„É´„ÉÄ„Ç¶„É≥Ôºâ„Çí‰Ωú„Çä„Åæ„Åô
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.model_files = glob.glob("gguf/*.gguf")  # gguf„Éï„Ç©„É´„ÉÄ„ÅÆ‰∏≠Ë∫´„ÇíÊ§úÁ¥¢
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if not self.model_files:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.model_files = ["„É¢„Éá„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"]

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.model_combo = ttk.Combobox(model_frame, values=self.model_files, width=50, state="readonly")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if self.model_files:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.model_combo.current(0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.model_combo.pack(side=tk.LEFT, padx=5)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Âàá„ÇäÊõø„Åà„Éú„Çø„É≥
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.change_btn = tk.Button(model_frame, text="ÂàáÊõø„ÉªÂÜçË™≠Ëæº", command=self.reload_model_trigger,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    bg="#98fb98", font=("Meiryo", 9))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.change_btn.pack(side=tk.LEFT, padx=5)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ‚òÖÊìç‰Ωú„Ç®„É™„Ç¢
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        top_frame = tk.Frame(root, bg="#f0f0f0", pady=10)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        top_frame.pack(side=tk.TOP, fill=tk.X)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # CSV„Éú„Çø„É≥
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.csv_btn = tk.Button(top_frame, text="üìÇ CSVË™≠Ëæº", command=self.load_csv,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 bg="#87ceeb", fg="white", font=("Meiryo", 10, "bold"), width=12)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.csv_btn.pack(side=tk.LEFT, padx=10)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ÂÖ•ÂäõÊ¨Ñ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.input_entry = tk.Entry(top_frame, font=("Meiryo", 12))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.input_entry.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=5)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.input_entry.bind("<Return>", self.send_message)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ÈÄÅ‰ø°„Éú„Çø„É≥
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.send_btn = tk.Button(top_frame, text="ÈÄÅ‰ø°", command=self.send_message,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  bg="#ffb6c1", fg="white", font=("Meiryo", 10, "bold"), width=10)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.send_btn.pack(side=tk.RIGHT, padx=10)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ‚òÖ„É≠„Ç∞„Ç®„É™„Ç¢
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.log_area = scrolledtext.ScrolledText(root, font=("Meiryo", 11), state='disabled')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.log_area.pack(expand=True, fill=tk.BOTH, padx=10, pady=10)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # --- 2. AI„ÅÆÊ∫ñÂÇô ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.system_prompt = "„Ç∑„Çπ„ÉÜ„É†: „ÅÇ„Å™„Åü„ÅØ„Éá„Éº„ÇøÂàÜÊûê„ÅåÂæóÊÑè„Å™AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇË´ñÁêÜÁöÑ„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.history = self.system_prompt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.llm = None

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Ëµ∑ÂãïÊôÇ„Å´ÊúÄÂàù„ÅÆ„É¢„Éá„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.reload_model_trigger()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def reload_model_trigger(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        selected_model = self.model_combo.get()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if selected_model == "„É¢„Éá„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            messagebox.showerror("„Ç®„É©„Éº", "gguf„Éï„Ç©„É´„ÉÄ„Å´„É¢„Éá„É´„Éï„Ç°„Ç§„É´„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑÔºÅ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.append_log("„Ç∑„Çπ„ÉÜ„É†", f"„Äå{os.path.basename(selected_model)}„Äç„Å´Âàá„ÇäÊõø„Åà„Å¶„ÅÑ„Åæ„Åô...Ôºà„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑÔºâ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.root.title("Ê∏ö„ÅÆAIÂàÜÊûê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà („É¢„Éá„É´Ë™≠Ëæº‰∏≠...)")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.change_btn.config(state="disabled")  # ÈÄ£ÊâìÈò≤Ê≠¢
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.send_btn.config(state="disabled")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        threading.Thread(target=self.load_model, args=(selected_model,), daemon=True).start()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def load_model(self, model_path):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Êó¢Â≠ò„ÅÆ„É¢„Éá„É´„Åå„ÅÇ„Çå„Å∞„É°„É¢„É™„ÇíËß£Êîæ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.llm = None

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # „É¢„Éá„É´Ë™≠„ÅøËæº„Åø
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.llm = Llama(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                model_path=model_path,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                n_ctx=8192,      # Ë®òÊÜ∂ÂäõMAX
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                n_threads=4,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                n_batch=512,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                verbose=False
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # ÂÆå‰∫ÜÂ†±Âëä
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.root.after(0, self.post_load_success, model_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.root.after(0, self.append_log, "„Ç®„É©„Éº", f"„É¢„Éá„É´Ë™≠ËæºÂ§±Êïó: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.root.after(0, lambda: self.change_btn.config(state="normal"))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def post_load_success(self, model_path):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        model_name = os.path.basename(model_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.append_log("„Ç∑„Çπ„ÉÜ„É†", f"Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ‰ªä„ÅØ„Äå{model_name}„Äç„ÅåÊãÖÂΩì„Åó„Åæ„Åô„ÄÇ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.root.title(f"Ê∏ö„ÅÆAIÂàÜÊûê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà - {model_name}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.change_btn.config(state="normal")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.send_btn.config(state="normal")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def load_csv(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        file_path = filedialog.askopenfilename(filetypes=[("CSV„Éï„Ç°„Ç§„É´", "*.csv")])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if not file_path:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            df = pd.read_csv(file_path)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            info_text = f"„Äê„Éá„Éº„ÇøÊ¶ÇË¶Å„Äë\nË°åÊï∞: {df.shape[0]}, ÂàóÊï∞: {df.shape[1]}\n\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            info_text += f"„ÄêÂàóÂêç‰∏ÄË¶ß„Äë\n{', '.join(df.columns)}\n\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            info_text += f"„Äê„Éá„Éº„Çø„ÅÆÂÖàÈ†≠5Ë°å„Äë\n{df.head().to_string()}\n\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            info_text += f"„ÄêÁµ±Ë®àÊÉÖÂ†±„Äë\n{df.describe().to_string()}"

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.append_log("„Ç∑„Çπ„ÉÜ„É†", f"„Äå{os.path.basename(file_path)}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            data_prompt = f"„É¶„Éº„Ç∂„Éº: ‰ª•‰∏ã„ÅÆCSV„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ\n{info_text}\n„Ç∑„Çπ„ÉÜ„É†: „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.history += data_prompt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            messagebox.showerror("„Ç®„É©„Éº", f"CSV„Ç®„É©„Éº: {e}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def send_message(self, event=None):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        user_text = self.input_entry.get()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if not user_text or self.llm is None:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.append_log("„ÅÇ„Å™„Åü", user_text)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.input_entry.delete(0, tk.END)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.history += f"„É¶„Éº„Ç∂„Éº: {user_text}\n„Ç∑„Çπ„ÉÜ„É†:"

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.root.title("ËÄÉ„Åà‰∏≠...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        threading.Thread(target=self.run_generation, daemon=True).start()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def run_generation(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            output = self.llm(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.history,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                max_tokens=500,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                temperature=0.1,  # Ë´ñÁêÜÁöÑ„É¢„Éº„Éâ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                top_p=0.9,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                repeat_penalty=1.1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                stop=["„É¶„Éº„Ç∂„Éº:", "\n\n"],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo=False
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            response = output['choices'][0]['text'].strip()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.history += f" {response}\n"

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.root.after(0, self.append_log, "AI", response)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            model_name = os.path.basename(self.model_combo.get())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.root.after(0, lambda: self.root.title(f"Ê∏ö„ÅÆAIÂàÜÊûê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà - {model_name}"))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.root.after(0, self.append_log, "„Ç®„É©„Éº", str(e))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def append_log(self, sender, text):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.log_area.config(state='normal')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.log_area.insert(tk.END, f"[{sender}] {text}\n\n")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.log_area.see(tk.END)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.log_area.config(state='disabled')


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    root = tk.Tk()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    app = AIChatApp(root)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    root.mainloop()

import tkinter as tk
from tkinter import scrolledtext, filedialog, messagebox
import threading
from llama_cpp import Llama
import pandas as pd # „Éá„Éº„ÇøÂàÜÊûê„ÅÆ„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´
import sys
„ÄÄ
class AIChatApp:
    def __init__(self, root):
            self.root = root
                    self.root.title("Ê∏ö„ÅÆAIÂàÜÊûê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà") # „Çø„Ç§„Éà„É´„ÇÇÂ§â„Åà„Åæ„Åó„Åü
                            self.root.geometry("700x750") 
                                    
                                            # --- 1. „Éá„Ç∂„Ç§„É≥ÈÉ®ÂàÜ ---
                                                    
                                                            # ‚òÖ‰∏äÈÉ®„Ç®„É™„Ç¢
                                                                    top_frame = tk.Frame(root, bg="#f0f0f0", pady=10)
                                                                            top_frame.pack(side=tk.TOP, fill=tk.X)
                                                                                    
                                                                                            # CSVË™≠„ÅøËæº„Åø„Éú„Çø„É≥ÔºàÊñ∞Ê©üËÉΩÔºÅÔºâ
                                                                                                    self.csv_btn = tk.Button(top_frame, text="üìÇ CSV„ÇíË™≠„ÅøËæº„ÇÄ", command=self.load_csv, 
                                                                                                                                      bg="#87ceeb", fg="white", font=("Meiryo", 10, "bold"), width=15)
                                                                                                                                              self.csv_btn.pack(side=tk.LEFT, padx=10)

                                                                                                                                                      # ÂÖ•Âäõ„ÉÜ„Ç≠„Çπ„Éà„Éú„ÉÉ„ÇØ„Çπ
                                                                                                                                                              self.input_entry = tk.Entry(top_frame, font=("Meiryo", 12))
                                                                                                                                                                      self.input_entry.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=5)
                                                                                                                                                                              self.input_entry.bind("<Return>", self.send_message)
                                                                                                                                                                                      
                                                                                                                                                                                              # ÈÄÅ‰ø°„Éú„Çø„É≥
                                                                                                                                                                                                      self.send_btn = tk.Button(top_frame, text="ÈÄÅ‰ø°", command=self.send_message, 
                                                                                                                                                                                                                                        bg="#ffb6c1", fg="white", font=("Meiryo", 10, "bold"), width=10)
                                                                                                                                                                                                                                                self.send_btn.pack(side=tk.RIGHT, padx=10)

                                                                                                                                                                                                                                                        # ‚òÖ‰∏ãÈÉ®„Ç®„É™„Ç¢
                                                                                                                                                                                                                                                                self.log_area = scrolledtext.ScrolledText(root, font=("Meiryo", 11), state='disabled')
                                                                                                                                                                                                                                                                        self.log_area.pack(expand=True, fill=tk.BOTH, padx=10, pady=10)
                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                        # --- 2. AI„ÅÆÊ∫ñÂÇô ---
                                                                                                                                                                                                                                                                                                # ‚Äª„Éï„Ç©„É´„ÉÄÊßãÊàê„Å´Âêà„Çè„Åõ„Å¶„Éë„Çπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„Å≠
                                                                                                                                                                                                                                                                                                        self.model_path = "gguf/gemma-2-2b-jpn-it-Q4_K_M.gguf"
                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                        # AI„Å∏„ÅÆÊúÄÂàù„ÅÆÊåáÁ§∫
                                                                                                                                                                                                                                                                                                                                self.system_prompt = "„Ç∑„Çπ„ÉÜ„É†: „ÅÇ„Å™„Åü„ÅØ„Éá„Éº„ÇøÂàÜÊûê„ÅåÂæóÊÑè„Å™AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇÊ∏°„Åï„Çå„Åü„Éá„Éº„Çø„Åã„ÇâÂÇæÂêë„ÇíË™≠„ÅøÂèñ„Çä„ÄÅÂàÜ„Åã„Çä„ÇÑ„Åô„ÅèËß£Ë™¨„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n"
                                                                                                                                                                                                                                                                                                                                        self.history = self.system_prompt
                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                        self.llm = None
                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                        self.append_log("„Ç∑„Çπ„ÉÜ„É†", "Ëµ∑Âãï‰∏≠... AI„É¢„Éá„É´„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô")
                                                                                                                                                                                                                                                                                                                                                                                threading.Thread(target=self.load_model, daemon=True).start()

                                                                                                                                                                                                                                                                                                                                                                                    def load_model(self):
                                                                                                                                                                                                                                                                                                                                                                                            try:
                                                                                                                                                                                                                                                                                                                                                                                                        self.llm = Llama(
                                                                                                                                                                                                                                                                                                                                                                                                                            model_path=self.model_path,
                                                                                                                                                                                                                                                                                                                                                                                                                                            n_ctx=2048,      # Ë®òÊÜ∂ÂÆπÈáè
                                                                                                                                                                                                                                                                                                                                                                                                                                                            n_threads=4,     # ÁØ§Âøó„Åè„ÇìÁî®Ë®≠ÂÆö
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            n_batch=512,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            verbose=False
                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                    self.root.after(0, self.append_log, "„Ç∑„Çπ„ÉÜ„É†", "Ê∫ñÂÇôÂÆå‰∫ÜÔºÅCSV„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄ„Åã„ÄÅË©±„Åó„Åã„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ")
                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                        self.root.after(0, self.append_log, "„Ç®„É©„Éº", f"„É¢„Éá„É´Ë™≠„ÅøËæº„ÅøÂ§±Êïó: {e}")

                                                                                                                                                                                                                                                                                                                                                                                                                                            def load_csv(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                    # CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åô„ÇãÁîªÈù¢„ÇíÈñã„Åç„Åæ„Åô
                                                                                                                                                                                                                                                                                                                                                                                                                                                            file_path = filedialog.askopenfilename(filetypes=[("CSV„Éï„Ç°„Ç§„É´", "*.csv")])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if not file_path:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return # „Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åü„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Pandas„ÅßCSV„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        df = pd.read_csv(file_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # --- AI„Å´Ë™≠„Åæ„Åõ„Çã„Åü„ÇÅ„ÅÆÂ∑•Â§´ ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # „Éá„Éº„Çø„ÅåÂ§ß„Åç„Åô„Åé„Çã„Å®AI„Åå„Éë„É≥„ÇØ„Åô„Çã„ÅÆ„Åß„ÄÅ„ÇÆ„É•„ÉÉ„Å®Ë¶ÅÁ¥Ñ„Åó„Åæ„Åô
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # 1. „Éá„Éº„Çø„ÅÆÂΩ¢Ôºà‰ΩïË°å‰ΩïÂàó„ÅÇ„Çã„ÅãÔºâ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                info_text = f"„Äê„Éá„Éº„ÇøÊ¶ÇË¶Å„Äë\nË°åÊï∞: {df.shape[0]}, ÂàóÊï∞: {df.shape[1]}\n\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # 2. Âàó„ÅÆÂêçÂâç
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    info_text += f"„ÄêÂàóÂêç‰∏ÄË¶ß„Äë\n{', '.join(df.columns)}\n\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # 3. „Éá„Éº„Çø„ÅÆÂÖàÈ†≠5Ë°åÔºà„Å©„Çì„Å™„Éá„Éº„Çø„ÅãÈõ∞Âõ≤Ê∞ó„Çí„Å§„Åã„ÇÄ„Åü„ÇÅÔºâ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        info_text += f"„Äê„Éá„Éº„Çø„ÅÆÂÖàÈ†≠5Ë°å„Äë\n{df.head().to_string()}\n\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # 4. Áµ±Ë®àÊÉÖÂ†±ÔºàÊï∞ÂÄ§„Éá„Éº„Çø„ÅÆÂπ≥Âùá„ÇÑÊúÄÂ§ß„ÉªÊúÄÂ∞è„Å™„Å©Ôºâ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # „Åì„Çå„Åå„ÅÇ„Çã„Å®„ÄåÂπ≥Âùá„Çà„ÇäÈ´ò„ÅÑ„Åß„Åô„Å≠„Äç„Åø„Åü„ÅÑ„Å™ÂàÜÊûê„Åå„Åß„Åç„Åæ„Åô
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        info_text += f"„ÄêÁµ±Ë®àÊÉÖÂ†±„Äë\n{df.describe().to_string()}"

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ÁîªÈù¢„Å´Â†±Âëä
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.append_log("„Ç∑„Çπ„ÉÜ„É†", f"„Äå{file_path}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ\n‰ª•‰∏ã„ÅÆÊÉÖÂ†±„ÇíAI„Å´Ë®òÊÜ∂„Åï„Åõ„Åæ„Åó„Åü„ÄÇ\n\n{info_text}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # AI„ÅÆË®òÊÜ∂ÔºàÂ±•Ê≠¥Ôºâ„Å´„Åì„Å£„Åù„ÇäËøΩÂä†
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # „É¶„Éº„Ç∂„Éº„Åå„Äå„Åì„ÅÆ„Éá„Éº„Çø„Å´„Å§„ÅÑ„Å¶Êïô„Åà„Å¶„Äç„Å®Ë®Ä„Å£„Åü„Åã„ÅÆ„Çà„ÅÜ„Å´Ë£Ö„ÅÑ„Åæ„Åô
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                data_prompt = f"„É¶„Éº„Ç∂„Éº: ‰ª•‰∏ã„ÅÆCSV„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ„Åì„ÅÆ„Éá„Éº„Çø„ÅÆÂÜÖÂÆπ„ÇíÊääÊè°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n{info_text}\n„Ç∑„Çπ„ÉÜ„É†: „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ„Å©„ÅÆ„Çà„ÅÜ„Å™ÂàÜÊûê„Çí„Åó„Åæ„Åô„ÅãÔºü\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.history += data_prompt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            messagebox.showerror("„Ç®„É©„Éº", f"CSV„ÅåË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü...\n{e}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def send_message(self, event=None):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        user_text = self.input_entry.get()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if not user_text or self.llm is None:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.append_log("„ÅÇ„Å™„Åü", user_text)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.input_entry.delete(0, tk.END)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Â±•Ê≠¥„Å´ËøΩÂä†
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.history += f"„É¶„Éº„Ç∂„Éº: {user_text}\n„Ç∑„Çπ„ÉÜ„É†:"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.root.title("Ê∏ö„ÅÆAIÂàÜÊûê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà (ÂàÜÊûê‰∏≠...)")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        threading.Thread(target=self.run_generation, daemon=True).start()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def run_generation(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # AI„Å´ËÄÉ„Åà„Å¶„ÇÇ„Çâ„ÅÜ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            output = self.llm(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.history,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                max_tokens=300, # ÂàÜÊûêÁµêÊûú„ÅØÂ∞ë„ÅóÈï∑„Åè„Å™„Çã„ÅÆ„ÅßÂ¢ó„ÇÑ„Åó„Åæ„Åó„Åü
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                stop=["„É¶„Éº„Ç∂„Éº:", "\n\n"],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo=False
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        response = output['choices'][0]['text'].strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.history += f" {response}\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.root.after(0, self.append_log, "AI", response)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.root.after(0, lambda: self.root.title("Ê∏ö„ÅÆAIÂàÜÊûê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà"))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.root.after(0, self.append_log, "„Ç®„É©„Éº", str(e))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def append_log(self, sender, text):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.log_area.config(state='normal')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.log_area.insert(tk.END, f"[{sender}] {text}\n\n")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.log_area.see(tk.END)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.log_area.config(state='disabled')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            root = tk.Tk()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                app = AIChatApp(root)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    root.mainloop()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                                                                                                                                                                                                                                                                        )